#!/bin/bash

# Dockerator - Multi-project Docker orchestration
# Similar to devner but for learning Docker concepts

# Auto-fix script permissions if needed
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ ! -x "$SCRIPT_DIR/scripts/new-wordpress.sh" ]; then
    chmod +x "$SCRIPT_DIR"/scripts/*.sh 2>/dev/null || true
fi

# Get the directory where this script is located
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$SCRIPT_DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Change to that directory so all paths work
cd "$SCRIPT_DIR"

# DEBUG - temporary
# echo "DEBUG: Script dir: $SCRIPT_DIR"
# echo "DEBUG: Current dir: $(pwd)"
# echo "DEBUG: Scripts directory contents:"
# ls -la scripts/ 2>&1 || echo "scripts/ not found!"
# echo ""


set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
show_header() {
    echo -e "${BLUE}"
    echo "╔════════════════════════════════════════╗"
    echo "║          DOCKERATOR                    ║"
    echo "║   Docker Multi-Project Manager         ║"
    echo "╚════════════════════════════════════════╝"
    echo -e "${NC}"
}

show_menu() {
    echo ""
    echo "Available commands:"
    echo "  up                 - Start all containers"
    echo "  down               - Stop all containers"
    echo "  new <type> <name>  - Create new project (nextjs, wp)"
    echo "  open <name>        - Open a project in VS Code"
    echo "  remove <name>      - Remove a project"
    echo "  dev-wp <name>      - Enter WordPress dev mode (with Vite)"
    echo "  dev-nextjs <name>  - Enter Next.js dev mode"
    echo "  list               - List all projects"
    echo "  logs <name>        - View logs for a project"
    echo "  hosts              - Sync /etc/hosts with all *.localhost domains"
    echo "  help               - Show this menu"
    echo ""
}

# Main script
show_header

# Check if command provided
if [ $# -eq 0 ]; then
    show_menu
    exit 0
fi

COMMAND=$1

case $COMMAND in
    new)
        if [ $# -lt 3 ]; then
            echo -e "${RED}Usage: dockerator new <type> <name>${NC}"
            echo "  Types: nextjs, wp (wordpress coming soon)"
            exit 1
        fi
        
        PROJECT_TYPE=$2
        PROJECT_NAME=$3
        
        case $PROJECT_TYPE in
            nextjs)
                ./scripts/new-nextjs.sh "$PROJECT_NAME"
                ;;
            wp)
                ./scripts/new-wordpress.sh "$PROJECT_NAME"
                ;;
            *)
                echo -e "${RED}Unknown project type: $PROJECT_TYPE${NC}"
                echo "Available types: nextjs, wp"
                exit 1
                ;;
        esac
        ;;
    remove)
        if [ -z "$2" ]; then
            echo -e "${RED}Usage: dockerator remove <name>${NC}"
            exit 1
        fi
        
        PROJECT_NAME=$2
        ./scripts/remove-project.sh "$PROJECT_NAME"
        ;;
    open)
        if [ -z "$2" ]; then
            echo -e "${RED}Usage: dockerator open <project-name>${NC}"
            exit 1
        fi
        
        PROJECT_NAME=$2
        ./scripts/open-project.sh "$PROJECT_NAME"
        ;;
    dev-wp)
        if [ -z "$2" ]; then
            echo -e "${RED}Usage: dockerator dev <project-name>${NC}"
            exit 1
        fi
        
        PROJECT_NAME=$2
        ./scripts/dev-mode.sh "$PROJECT_NAME"
        ;;
    dev-nextjs)
        if [ -z "$2" ]; then
            echo -e "${RED}Usage: dockerator dev-nextjs <project-name>${NC}"
            exit 1
        fi
        
        PROJECT_NAME=$2
        ./scripts/dev-mode-nextjs.sh "$PROJECT_NAME"
        ;;
    hosts)
        echo "DEBUG: Running sync-hosts.sh"
        echo "DEBUG: Current dir: $(pwd)"
        echo "DEBUG: Script exists: $(ls -la scripts/sync-hosts.sh 2>&1)"
        ./scripts/sync-hosts.sh
        ;;
    list)
        ./scripts/list-projects.sh
        ;;
    up)
        docker-compose up -d
        ;;
    down)
        docker-compose down
        ;;
    logs)
        if [ -n "$2" ]; then
            docker-compose logs -f "$2"
        else
            docker-compose logs -f
        fi
        ;;
    help)
        show_menu
        ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        show_menu
        exit 1
        ;;
esac